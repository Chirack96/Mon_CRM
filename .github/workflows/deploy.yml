name: CI/CD Pipeline for Angular and Spring Boot

on:
  push:
    branches:
      - main

jobs:
  merge_to_production:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0  # Récupère tout l'historique et toutes les branches

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge main into production
        run: |
          git fetch origin  # Assure que la branche production est récupérée
          if git rev-parse --verify production; then
            git checkout production
          else
            git checkout -b production origin/production
          fi
          git merge main --no-commit --no-ff  # Effectue la fusion sans commettre automatiquement
          git restore --staged .github/workflows/  # Réinitialise les workflows pour ne pas les inclure dans le commit
          git commit -m "Merge main into production, excluding workflow changes"
          git push origin production  # Pousse la branche fusionnée

  build_and_push_images:
    needs: merge_to_production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout production branch
        uses: actions/checkout@v3
        with:
          ref: production
          fetch-depth: 0  # Récupère tout l'historique et toutes les branches

      - name: Build and push Backend (Spring Boot) Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/springboot-app:latest ./dev
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          docker push ${{ secrets.DOCKER_USERNAME }}/springboot-app:latest  # Pousse l'image backend avec le bon nom

      - name: Build and push Frontend (Angular) Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/angular-app:latest ./Frontend  # Utilise le bon chemin pour le frontend
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          docker push ${{ secrets.DOCKER_USERNAME }}/angular-app:latest  # Pousse l'image frontend avec le bon nom

  deploy_to_server:
    needs: build_and_push_images
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to local server via SSH
        uses: appleboy/ssh-action@v0.1.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            cd C:/Users/chira/Documents/Pro/Mon_CRM
            docker-compose pull
            docker-compose up -d
